name: QuanlityInnovations SonarCloud GitHub Action
description: 'Scans, Quality Gates, PR Comments, and Annotations'

branding:
  icon: check-circle
  color: green

inputs:
  scoverageReport:
    description: The path to the Scoverage report in XML format
    required: false

  args:
    description: Additional arguments to the SonarCloud scanner
    required: false

  teamName:
    description: 'The SonarQube team name'
    required: true
    default: 'team'

  projectBaseDir:
    description: 'The project base directory'
    required: false
    default: .

  sonarHostUrl:
    description: 'The SonarQube Host Url'
    required: false
    default: 'https://sonarcloud.io/'

  SONAR_TOKEN:
    description: 'SonarCloud or SonarQube authentication token'
    required: true


runs:
  using: composite
  steps:
     - name: Replace all working directory paths with sources path
       run: if [[ -n "${{ inputs.scoverageReport }}" ]]; then sed -i -e s,`pwd`,/github/workspace,g ${{ inputs.scoverageReport }}; fi
       shell: bash

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master  # Use a stable version instead of master
      with:
         args: ${{ inputs.args }}
         projectBaseDir: ${{ inputs.projectBaseDir }}
      env:
        # SONAR_TOKEN: ${{ inputs.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ inputs.sonarHostUrl }}

    - name: SonarQube Quality Gate check
      uses: sonarsource/sonarqube-quality-gate-action@master  # Use a stable version instead of master
      id: sonarqube-quality-gate-check
      env:
        # SONAR_TOKEN: ${{ inputs.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ inputs.sonarHostUrl }}

    - name: SonarQube Quality Gate Comment
      id: sonarqube-quality-gate-comment
      shell: bash
      run: echo "Future Feature!"

    - name: "Show SonarQube Quality Gate Status"
      shell: bash
      run: |
        if [ -n "${{ steps.sonarqube-quality-gate-check.outputs.quality-gate-status }}" ]; then
          echo "The Quality Gate status is ${{ steps.sonarqube-quality-gate-check.outputs.quality-gate-status }}"
        else
          echo "Quality Gate status is not available."
        fi
