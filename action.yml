name: QuanlityInnovations SonarQube GitHub Action
description: 'Scans, Quality Gates, PR Comments, and Annotations'

branding:
  icon: check-circle
  color: green

inputs:
  scoverageReport:
    description: 'The path to the Scoverage report in XML format'
    required: false

  args:
    description: 'Additional arguments to the SonarQube scanner'
    required: false

  teamName:
    description: 'The SonarQube team name'
    required: true
    default: 'team'

  projectBaseDir:
    description: 'The project base directory'
    required: false
    default: .

  SONAR_HOST_URL:
    description: 'The SonarQube Host Url'
    required: false
    default: 'https://sonarcloud.io/'

  SONAR_TOKEN:
    description: 'SonarQube authentication token'
    required: true

runs:
  using: composite
  steps:
    - name: Fix directory paths with sources path
      run: |
        if [[ -n "${{ inputs.scoverageReport }}" ]]; then
          sed -i -e "s,`pwd`,/github/workspace,g" ${{ inputs.scoverageReport }};
        fi
      shell: bash

    - name: SonarQube Scan
      uses: SonarSource/sonarcloud-github-action@master
      with:
        args: ${{ inputs.args }}
        projectBaseDir: ${{ inputs.projectBaseDir }}     

    - name: SonarQube Quality Gate check
      uses: sonarsource/sonarqube-quality-gate-action@master
      id: sonarqube-quality-gate-check     

    - name: SonarQube Quality Gate Comment
      id: sonarqube-quality-gate-comment
      shell: bash
      run: echo "Future Feature!"

    - name: "Show SonarQube Quality Gate Status"
      shell: bash
      run: |
        if [ -n "${{ steps.sonarqube-quality-gate-check.outputs.quality-gate-status }}" ]; then
          echo "The Quality Gate status is ${{ steps.sonarqube-quality-gate-check.outputs.quality-gate-status }}"
        else
          echo "Quality Gate status is not available."
        fi
